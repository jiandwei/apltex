name: Build and Release aplTeX for Windows

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€æ ‡ç­¾å¦‚ v1.0.0 æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  BUILD_DIR: build
  DIST_DIR: aplTeX-windows
  ZIP_NAME: aplTeX-windows-x64.zip

jobs:
  build-windows:
    runs-on: windows-latest
    
    strategy:
      fail-fast: false  # ä¸€ä¸ªä½œä¸šå¤±è´¥ä¸å½±å“å…¶ä»–ä½œä¸šï¼ˆå¦‚æœæœ‰å¤šä¸ªæ„å»ºçŸ©é˜µï¼‰
  
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive  # å¦‚æœéœ€è¦å­æ¨¡å—

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            git
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-clang
            mingw-w64-x86_64-harfbuzz
            mingw-w64-x86_64-lua
            mingw-w64-x86_64-freetype  # æ·»åŠ  freetype ä¾èµ–
            mingw-w64-x86_64-graphite2 # æ·»åŠ  graphite2 ä¾èµ–

      - name: Build aplTeX
        shell: msys2 {0}
        run: |
          echo "Starting aplTeX build for Windows..."
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export PATH="/mingw64/bin:$PATH"
          
          # åˆ›å»ºæ„å»ºç›®å½•
          mkdir -p ${{ env.BUILD_DIR }}
          cd ${{ env.BUILD_DIR }}
          
          # å…‹éš† Web2C ä»“åº“
          if [ ! -d "texlive-source" ]; then
            echo "Cloning TeX Live source..."
            git clone https://github.com/TeX-Live/texlive-source.git
          fi
          
          cd texlive-source
          
          # æ£€æŸ¥ç‰¹å®šç‰ˆæœ¬
          git checkout svn66987 || echo "Using default branch"
          
          # æ¸…ç†ä¹‹å‰çš„æ„å»º
          make distclean 2>/dev/null || true
          
          # é…ç½®
          echo "Configuring build..."
          ./configure \
            --disable-shared \
            --enable-static \
            --with-banner-add="/aplTeX" \
            --disable-all-pkgs \
            --enable-luatex \
            --with-system-harfbuzz \
            --with-system-lua53 \
            --with-system-freetype2 \
            --with-system-graphite2 \
            --disable-largefile \
            --disable-ipc \
            --disable-dump-share \
            --disable-tex \
            --disable-etex \
            --disable-pdftex \
            --disable-xetex \
            CC=gcc \
            CFLAGS="-O2 -static -D_WIN32_WINNT=0x0600" \
            LDFLAGS="-static"
          
          # ç¼–è¯‘
          echo "Building..."
          make -j$(nproc)
          
          # éªŒè¯æ„å»º
          if [ -f "texk/web2c/luatex.exe" ]; then
            # æ£€æŸ¥æ–‡ä»¶ç±»å‹
            file texk/web2c/luatex.exe
            # æ£€æŸ¥æ˜¯å¦é™æ€é“¾æ¥
            ldd texk/web2c/luatex.exe 2>/dev/null && echo "Warning: Not fully static!" || true
          else
            echo "Error: luatex.exe not found!"
            exit 1
          fi
          
          # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
          mkdir -p ../../${{ env.DIST_DIR }}/bin
          cp texk/web2c/luatex.exe ../../${{ env.DIST_DIR }}/bin/
          
          cd ../..
          echo "Build completed successfully!"

      - name: Verify executable
        shell: bash
        run: |
          echo "Verifying executable..."
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "${{ env.DIST_DIR }}/bin/luatex.exe" ]; then
            echo "âœ“ luatex.exe found"
            # å°è¯•è·å–ç‰ˆæœ¬ä¿¡æ¯
            "${{ env.DIST_DIR }}/bin/luatex.exe" --version | head -5 || echo "Warning: Could not run luatex"
          else
            echo "âœ— luatex.exe not found"
            exit 1
          fi

      - name: Prepare distribution package
        shell: pwsh
        run: |
          Write-Host "Preparing distribution package..."
          
          # åˆ›å»ºç›®å½•ç»“æ„
          $distDir = "${{ env.DIST_DIR }}"
          
          New-Item -ItemType Directory -Force -Path "$distDir/texmf/tex/latex" | Out-Null
          New-Item -ItemType Directory -Force -Path "$distDir/texmf/fonts/tfm" | Out-Null
          New-Item -ItemType Directory -Force -Path "$distDir/texmf/fonts/type1" | Out-Null
          New-Item -ItemType Directory -Force -Path "$distDir/texmf/fonts/opentype" | Out-Null
          New-Item -ItemType Directory -Force -Path "$distDir/texmf/web2c" | Out-Null
          New-Item -ItemType Directory -Force -Path "$distDir/scripts" | Out-Null
          
          # å¦‚æœå­˜åœ¨è‡ªå®šä¹‰ texmf å†…å®¹ï¼Œå¤åˆ¶å®ƒä»¬
          if (Test-Path "texmf") {
            Write-Host "Copying custom texmf files..."
            Copy-Item -Recurse "texmf/*" "$distDir/texmf/" -ErrorAction SilentlyContinue
          }
          
          # åˆ›å»ºåŸºæœ¬æ ¼å¼æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
          if (Test-Path "$distDir/texmf/tex/plain") {
            # å¦‚æœæœ‰ plain.texï¼Œå¯ä»¥åœ¨è¿™é‡Œåˆ›å»ºæ ¼å¼æ–‡ä»¶
            Write-Host "Format files should be created by user as per README"
          }
          
          # åˆ›å»ºç‰ˆæœ¬æ–‡ä»¶
          $version = if ($env:GITHUB_REF -match 'refs/tags/(.*)') { 
            $matches[1] 
          } else { 
            "dev-$(git rev-parse --short HEAD)" 
          }
          
          @"aplTeX Windows Distribution
            Version: $version
            Build Date: $(Get-Date -Format 'yyyy-MM-dd')
            Git Commit: $(git rev-parse HEAD)
            Platform: Windows x86_64
          "@ | Out-File -FilePath "$distDir/VERSION.txt" -Encoding UTF8

      - name: Create ZIP archive
        shell: pwsh
        run: |
          Write-Host "Creating ZIP archive..."
          
          # è®¡ç®—ç›®å½•å¤§å°
          $size = (Get-ChildItem "${{ env.DIST_DIR }}" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
          Write-Host "Distribution size: $($size.ToString('N2')) MB"
          
          # åˆ›å»ºZIP
          Compress-Archive -Path "${{ env.DIST_DIR }}/*" -DestinationPath "${{ env.ZIP_NAME }}" -CompressionLevel Optimal
          
          # æ˜¾ç¤ºZIPä¿¡æ¯
          $zipSize = (Get-Item "${{ env.ZIP_NAME }}").Length / 1MB
          Write-Host "Created ${{ env.ZIP_NAME }} ($($zipSize.ToString('N2')) MB)"
          
          # éªŒè¯ZIP
          if (Test-Path "${{ env.ZIP_NAME }}") {
            Write-Host "âœ“ ZIP archive created successfully"
          } else {
            Write-Host "âœ— Failed to create ZIP archive"
            exit 1
          }

      - name: Get version info
        id: version
        shell: pwsh
        run: |
          if ($env:GITHUB_REF -match 'refs/tags/(.*)') {
            $tag = $matches[1]
            $version = $tag.TrimStart('v')
          } else {
            $version = "dev-$(git rev-parse --short HEAD)"
          }
          
          $date = Get-Date -Format 'yyyy-MM-dd'
          
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "tag=$($tag ?? '')" >> $env:GITHUB_OUTPUT
          echo "date=$date" >> $env:GITHUB_OUTPUT
          Write-Host "Version: $version"
          Write-Host "Tag: $($tag ?? 'none')"
          Write-Host "Date: $date"

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ env.ZIP_NAME }}
          draft: false
          prerelease: false
          generate_release_notes: true
          name: aplTeX ${{ steps.version.outputs.version }} for Windows
          body: |
            ## aplTeX ${{ steps.version.outputs.version }} for Windows
            
            ### ğŸ“¥ ä¸‹è½½
            - [aplTeX-windows-x64.zip](aplTeX-windows-x64.zip) - å®Œæ•´çš„ Windows å‘è¡Œç‰ˆ
            
            ### ğŸš€ å¿«é€Ÿå¼€å§‹
            1. ä¸‹è½½å¹¶è§£å‹ ZIP æ–‡ä»¶
            2. è¿è¡Œ `install.bat` é…ç½®ç¯å¢ƒå˜é‡
            3. é‡å¯å‘½ä»¤æç¤ºç¬¦
            4. éªŒè¯å®‰è£…: `luatex --version`
            
            ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
            - Windows 10/11 (64ä½)
            - ä¸éœ€è¦é¢å¤–ä¾èµ–
            
            ### ğŸ”§ æ„å»ºä¿¡æ¯
            - æ„å»ºæ—¶é—´: ${{ steps.version.outputs.date }}
            - Git Commit: ${{ github.sha }}
            
            ### ğŸ“š æ–‡æ¡£
            è§£å‹åçš„ README.md åŒ…å«è¯¦ç»†è¯´æ˜ã€‚
            
            ### ğŸ› é—®é¢˜åé¦ˆ
            è¯·åœ¨ [Issues](https://github.com/RadioNoiseE/apltex/issues) é¡µé¢æŠ¥å‘Šé—®é¢˜ã€‚
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifact (for manual runs)
        uses: actions/upload-artifact@v4
        if: always() && github.event_name == 'workflow_dispatch'
        with:
          name: aplTeX-windows-x64-${{ github.run_id }}
          path: |
            ${{ env.ZIP_NAME }}
            ${{ env.DIST_DIR }}/VERSION.txt
          retention-days: 30

      - name: Cleanup (optional)
        if: always()
        shell: pwsh
        run: |
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
          Write-Host "Cleaning up temporary files..."
          Remove-Item -Recurse -Force ${{ env.BUILD_DIR }} -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force ${{ env.DIST_DIR }} -ErrorAction SilentlyContinue
